---
layout: post
title: "题解：[NOIP2023] 天天爱打卡"
subtitle: "洛谷P9871"
date: 2025-8-5
author: "TH911"
header-img: "img/2024/10/006.jpeg"
header-mask: 0.4
tags:
  - 题解
  - 省选/NOI−
  - DP
  - 线段树优化 DP
words:
---

> [题目传送门](https://www.luogu.com.cn/problem/P9871)

记 $[l,r,w]$ 表示 $l\sim r$ 每天都跑步，小 T 请用户吃饭造成的提高为 $w$。

# 测试点 $1\sim9$

一个非常显然的 $\mathcal O(nk)$ 的 DP。

设 $\textit{dp}_{i,j}$ 为在第 $i$ 天**结束时**连续打卡了 $j$ 天的最大能量值。

则有：

$$
\begin{aligned}
\textit{dp}_{i,0}&=\max_{j=0}^{k}\textit{dp}_{i-1,j}\\
\textit{dp}_{i,j}&=\textit{dp}_{i-1,j-1}+\sum_{x_l=i\land j\geq y_l}v_l
\end{aligned}
$$

答案即 $\max\limits_{i=0}^k\textit{dp}_{n,i}$。

期望得分：$\text{36pts}$。

<details class="success">
    <summary>参考代码</summary>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="c1">//#include&lt;bits/stdc++.h&gt;</span>
<span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;ctime&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;deque&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stack&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mf">1e5</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">dp</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">K</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">void</span> <span class="nf">Start</span><span class="p">(){</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dp</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="cm">/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/</span>

	<span class="n">ios</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">cout</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">T</span><span class="p">;</span>
	<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="n">T</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="o">--</span><span class="p">){</span>
		<span class="n">Start</span><span class="p">();</span>
		<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="n">m</span><span class="o">&gt;&gt;</span><span class="n">k</span><span class="o">&gt;&gt;</span><span class="n">d</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">;</span>
			<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="n">y</span><span class="o">&gt;&gt;</span><span class="n">v</span><span class="p">;</span>
			<span class="n">a</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">push_back</span><span class="p">({</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">});</span>
		<span class="p">}</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
				<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
				<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">d</span><span class="p">;</span>
				<span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="n">pl</span><span class="o">:</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
					<span class="kt">int</span> <span class="o">&amp;</span><span class="n">y</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="o">&amp;</span><span class="n">v</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
					<span class="k">if</span><span class="p">(</span><span class="n">j</span><span class="o">&gt;=</span><span class="n">y</span><span class="p">){</span>
						<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+=</span><span class="n">v</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ll</span> <span class="n">ans</span><span class="o">=</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">ans</span><span class="o">&lt;&lt;</span><span class="sc">'\n'</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
	 
	<span class="cm">/*fclose(stdin);
	fclose(stdout);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
</details>

***

考虑优化上面的 DP，所以更改 DP 状态，因为 $\mathcal O(1)$ 转移已经**不能继续优化**。

***

# 测试点 $1\sim7$

设 $$\textit{dp}_{i,1},\textit{dp}_{i,0}$$ 分别为第 $i$ 天是否跑步的最大能量值。

则有：

$$
\begin{aligned}
\textit{dp}_{i,0}&=\max_{j=1}^{i-1}\textit{dp}_{j,1}=\max\left(\textit{dp}_{i-1,0},\textit{dp}_{i-1,1}\right)\\
\textit{dp}_{i,1}&=\max_{j=1}^{\min(i,k)}\left(\textit{dp}_{i-j,0}-j\cdot d+\operatorname{calc}(i-j+1,i)\right)
\end{aligned}
$$
其中，$\operatorname{calc}(l,r)$ 表示 $l\sim r$ 一直跑步增加的能量值，显然可以 $\mathcal O(m)$ 计算。

于是得到了一个更劣的 $\mathcal O(nmk)$ 的解法。将给定的 $[l_i,r_i]$ 按照 $r_i$ 排序后单次计算 $\operatorname{calc}(l,r)$ 时在给定区间上二分，可以减小常数。期望复杂度为 $\mathcal O\left(nk\left(\log m+\dfrac mn\right)\right)=\mathcal O\left(nk\log m+mk\right)$。

期望得分 $\text{28pts}$。

<details class="success">
    <summary>参考代码</summary>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="rouge-code"><pre><span class="c1">//#include&lt;bits/stdc++.h&gt;</span>
<span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;ctime&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;deque&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stack&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mf">1e5</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">line</span><span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">;</span>
<span class="p">}</span><span class="n">a</span><span class="p">[</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">dp</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="n">ll</span> <span class="nf">calc</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">){</span>
	<span class="n">ll</span> <span class="n">ans</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">L</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="n">m</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">L</span><span class="o">&lt;</span><span class="n">R</span><span class="p">){</span>
		<span class="kt">int</span> <span class="n">mid</span><span class="o">=</span><span class="n">L</span><span class="o">+</span><span class="n">R</span><span class="o">+</span><span class="mi">1</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">mid</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">L</span><span class="o">=</span><span class="n">mid</span><span class="p">;</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>
			<span class="n">R</span><span class="o">=</span><span class="n">mid</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">L</span><span class="p">;</span><span class="mi">1</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&amp;&amp;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="o">&amp;&amp;</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">Start</span><span class="p">(){</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dp</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="cm">/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/</span>

	<span class="n">ios</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">cout</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">T</span><span class="p">;</span>
	<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="n">T</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="o">--</span><span class="p">){</span>
		<span class="n">Start</span><span class="p">();</span>
		<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="n">m</span><span class="o">&gt;&gt;</span><span class="n">k</span><span class="o">&gt;&gt;</span><span class="n">d</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="o">&amp;</span><span class="n">r</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span><span class="o">&amp;</span><span class="n">w</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
			<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="n">y</span><span class="o">&gt;&gt;</span><span class="n">w</span><span class="p">;</span>
			<span class="n">r</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
			<span class="n">l</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,[](</span><span class="n">line</span> <span class="n">a</span><span class="p">,</span><span class="n">line</span> <span class="n">b</span><span class="p">){</span>
			<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
		<span class="p">});</span>
<span class="c1">//		for(int i=1;i&lt;=m;i++){</span>
<span class="c1">//			cerr&lt;&lt;"["&lt;&lt;a[i].l&lt;&lt;","&lt;&lt;a[i].r&lt;&lt;"]:"&lt;&lt;a[i].w&lt;&lt;endl;</span>
<span class="c1">//		} </span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">d</span><span class="o">+</span><span class="n">calc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&amp;&amp;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">k</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
				<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1ll</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="n">d</span><span class="o">+</span><span class="n">calc</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="sc">'\n'</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
	 
	<span class="cm">/*fclose(stdin);
	fclose(stdout);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
</details>

# 测试点 $8\sim11$

考虑优化上面的 DP。

发现 $\operatorname{calc}(l,r)$ 具有的性质就是 $r$ 单调递增。因此可以想到数据结构维护 $l_i$ 处增加的 $w_i$。

在 DP 之前将 $[l_i,r_i]$ 按 $r_i$ 排序，DP 时依次加入即可。设 $\operatorname{query}(x)$ 表示 $l_i\geq x$ 的 $w_i$ 之和。

则有：

$$
\begin{aligned}
\textit{dp}_{i,0}&=\max\left(\textit{dp}_{i-1,0},\textit{dp}_{i-1,1}\right)\\
\textit{dp}_{i,1}&=\max_{j=\max(i-k,0)}^{i-1}\left(\textit{dp}_{j,0}-(i-j)d+\operatorname{query}(j+1)\right)
\end{aligned}
$$


时间复杂度：$\mathcal O((nk+m)\log m)$。期望得分：$\text{36pts}$。~~原地打转。~~

<details class="success">
    <summary>参考代码</summary>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre></td><td class="rouge-code"><pre><span class="c1">//#include&lt;bits/stdc++.h&gt;</span>
<span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;ctime&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;deque&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stack&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mf">1e5</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">BIT</span><span class="p">{</span>
	<span class="n">ll</span> <span class="n">t</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Tag</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">clear</span><span class="p">(){</span>
		<span class="n">Tag</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">int</span> <span class="nf">lowbit</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">){</span>
		<span class="k">return</span> <span class="n">x</span><span class="o">&amp;-</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">){</span>
		<span class="n">ll</span> <span class="n">ans</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">&lt;=</span><span class="n">N</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">!=</span><span class="n">Tag</span><span class="p">){</span>
				<span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">tag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="n">Tag</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ans</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
			<span class="n">x</span><span class="o">+=</span><span class="n">lowbit</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="kt">int</span> <span class="n">k</span><span class="p">){</span>
		<span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">!=</span><span class="n">Tag</span><span class="p">){</span>
				<span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">tag</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">=</span><span class="n">Tag</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">+=</span><span class="n">k</span><span class="p">;</span>
			<span class="n">x</span><span class="o">-=</span><span class="n">lowbit</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span><span class="n">t</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">line</span><span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">;</span>
<span class="p">}</span><span class="n">a</span><span class="p">[</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">dp</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">void</span> <span class="nf">Start</span><span class="p">(){</span>
	<span class="n">t</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dp</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="cm">/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/</span>

	<span class="n">ios</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">cout</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">T</span><span class="p">;</span>
	<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="n">T</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="o">--</span><span class="p">){</span>
		<span class="n">Start</span><span class="p">();</span>
		<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="n">m</span><span class="o">&gt;&gt;</span><span class="n">k</span><span class="o">&gt;&gt;</span><span class="n">d</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="o">&amp;</span><span class="n">r</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span><span class="o">&amp;</span><span class="n">w</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
			<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="n">y</span><span class="o">&gt;&gt;</span><span class="n">w</span><span class="p">;</span>
			<span class="n">r</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
			<span class="n">l</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,[](</span><span class="n">line</span> <span class="n">a</span><span class="p">,</span><span class="n">line</span> <span class="n">b</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">!=</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">){</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">});</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			
			<span class="k">while</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;=</span><span class="n">m</span><span class="o">&amp;&amp;</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">){</span>
				<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">w</span><span class="p">);</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mi">1ll</span><span class="o">&lt;&lt;</span><span class="mi">60</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
				<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1ll</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="n">t</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="sc">'\n'</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
	 
	<span class="cm">/*fclose(stdin);
	fclose(stdout);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
</details>

# 测试点 $10\sim14$

发现 $\textit{dp}_{i,1}$ 的递推式其实是一个区间递推，因此可以考虑线段树优化 DP。

线段树维护 $\textit{dp}_{j,0}$ 对于 DP 的贡献，即 $\textit{dp}_{j,0}-(i-j)d+\operatorname{query}(j+1)$。

* $-(i-j)d$ 在 $i$ 变化时可以通过区间加法维护，在 $[0,i-1]$ 上减去 $d$ 即可。
* $\operatorname{query}(j+1)$ 在 $i$ 变化时维护对应增加的 $[l,r,w]$，在线段树上的 $[0，l-1]$ 这段区间进行区间加法加 $w$ 即可。
* 查询只需要线段树维护区间 $[\max(i-k,0),i-1]$ 最大值即可。

时间复杂度：$\mathcal O(n\log n+m\log m)$。期望得分：$\text{56pts}$。

<details class="success">
    <summary>参考代码</summary>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
</pre></td><td class="rouge-code"><pre><span class="c1">//#include&lt;bits/stdc++.h&gt;</span>
<span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;ctime&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;deque&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stack&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">ll</span> <span class="n">inf</span><span class="o">=</span><span class="mh">0x3f3f3f3f3f3f3f3f</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mf">1e5</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">line</span><span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">;</span>
<span class="p">}</span><span class="n">a</span><span class="p">[</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="k">struct</span> <span class="nc">segTree</span><span class="p">{</span>
	<span class="k">struct</span> <span class="nc">node</span><span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">max</span><span class="p">,</span><span class="n">tag</span><span class="p">;</span>
	<span class="p">}</span><span class="n">t</span><span class="p">[</span><span class="n">N</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="o">|</span><span class="mi">1</span><span class="p">];</span>

	<span class="kt">void</span> <span class="nf">up</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
		<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">].</span><span class="n">max</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">].</span><span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">build</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">){</span>
		<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">==</span><span class="n">r</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kt">int</span> <span class="n">mid</span><span class="o">=</span><span class="n">l</span><span class="o">+</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">build</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">mid</span><span class="p">);</span>
		<span class="n">build</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">,</span><span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">down</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span><span class="n">ll</span> <span class="n">k</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">&amp;&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">k</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">k</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span><span class="p">){</span>
			<span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">].</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">up</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">&amp;&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ll</span> <span class="n">ans</span><span class="o">=-</span><span class="n">inf</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">].</span><span class="n">r</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">=</span><span class="n">query</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">].</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span><span class="n">query</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="mi">1</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span><span class="n">t</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">dp</span><span class="p">[</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="cm">/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/</span>
	
	<span class="n">ios</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">cout</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">T</span><span class="p">;</span>
	<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">c</span><span class="o">&gt;&gt;</span><span class="n">T</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="o">--</span><span class="p">){</span>
		<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">n</span><span class="o">&gt;&gt;</span><span class="n">m</span><span class="o">&gt;&gt;</span><span class="n">k</span><span class="o">&gt;&gt;</span><span class="n">d</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">build</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="o">&amp;</span><span class="n">r</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span><span class="o">&amp;</span><span class="n">w</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
			<span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">x</span><span class="o">&gt;&gt;</span><span class="n">y</span><span class="o">&gt;&gt;</span><span class="n">w</span><span class="p">;</span>
			<span class="n">r</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
			<span class="n">l</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,[](</span><span class="n">line</span> <span class="n">a</span><span class="p">,</span><span class="n">line</span> <span class="n">b</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">!=</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">){</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">});</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">while</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;=</span><span class="n">m</span><span class="o">&amp;&amp;</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">){</span>
				<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">w</span><span class="p">);</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">d</span><span class="p">);</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="sc">'\n'</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
	 
	<span class="cm">/*fclose(stdin);
	fclose(stdout);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
</details>

# 测试点 $15\sim25$

考虑优化。

拆式子，得到：
$$
\textit{dp}_{i,1}=\max_{j=\max(i-k,0)}^{i-1}\left(\textit{dp}_{j,0}+jd+\operatorname{query}(j+1)\right)-id
$$
这样，就避免了 $i$ 对 $j$ 的贡献的影响，$j$ 的贡献即 $\textit{dp}_{j,0}+jd+\operatorname{query}(j+1)$。这是确定的，并且可以发现有效的决策点一定是 $l-1$ 和 $r$。那么离散化 $l-1,r$，在 $l-1,r$ 上决策即可。

操作可以在动态开点权值线段树上维护，但是被卡常了。[Loj](https://loj.ac/s/2390299)上有 $\text{84pts}$，[洛谷](https://www.luogu.com.cn/record/229172999)上只有 $\text{60pts}$。

<details class="success">
    <summary>参考代码</summary>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><div class="table-responsive"><table class="rouge-table table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
</pre></td><td class="rouge-code"><pre><span class="c1">//#include&lt;bits/stdc++.h&gt;</span>
<span class="cp">#include</span><span class="cpf">&lt;algorithm&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstring&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;iomanip&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;cmath&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;ctime&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;deque&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;queue&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;stack&gt;</span><span class="cp">
#include</span><span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">namespace</span> <span class="n">io</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ibuf</span><span class="p">[</span><span class="n">SIZE</span><span class="p">],</span> <span class="o">*</span><span class="n">iS</span><span class="p">,</span> <span class="o">*</span><span class="n">iT</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">obuf</span><span class="p">[</span><span class="n">SIZE</span><span class="p">],</span> <span class="o">*</span><span class="n">oS</span> <span class="o">=</span> <span class="n">obuf</span><span class="p">,</span> <span class="o">*</span><span class="n">oT</span> <span class="o">=</span> <span class="n">oS</span> <span class="o">+</span> <span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">qu</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">qr</span><span class="p">;</span>

	<span class="cp">#define gc() (iS == iT ? (iT = (iS = ibuf) + fread (ibuf, 1, SIZE, stdin), (iS == iT ? EOF : *iS ++)) : *iS ++)
</span>	
	<span class="kr">inline</span> <span class="kt">void</span> <span class="n">flush</span> <span class="p">()</span> <span class="p">{</span>
		<span class="n">fwrite</span> <span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oS</span> <span class="o">-</span> <span class="n">obuf</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
		<span class="n">oS</span> <span class="o">=</span> <span class="n">obuf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">putc</span> <span class="p">(</span><span class="kt">char</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">oS</span> <span class="o">++</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oS</span> <span class="o">==</span> <span class="n">oT</span><span class="p">)</span> <span class="n">flush</span> <span class="p">();</span>
	<span class="p">}</span>
	<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">&gt;</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">IN</span> <span class="p">(</span><span class="n">I</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">gc</span><span class="p">();</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="sc">'0'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="sc">'9'</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">gc</span><span class="p">())</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'-'</span><span class="p">)</span> <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'9'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'0'</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">gc</span><span class="p">())</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">);</span> 
		<span class="n">x</span> <span class="o">=</span> <span class="n">f</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="n">x</span> <span class="o">:</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">&gt;</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print</span> <span class="p">(</span><span class="n">I</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">x</span><span class="p">)</span> <span class="n">putc</span> <span class="p">(</span><span class="sc">'0'</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">putc</span> <span class="p">(</span><span class="sc">'-'</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">qu</span><span class="p">[</span> <span class="o">++</span> <span class="n">qr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">,</span>  <span class="n">x</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">qr</span><span class="p">)</span> <span class="n">putc</span> <span class="p">(</span><span class="n">qu</span><span class="p">[</span><span class="n">qr</span> <span class="o">--</span> <span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">struct</span> <span class="nc">Flusher_</span> <span class="p">{</span><span class="o">~</span><span class="n">Flusher_</span><span class="p">(){</span><span class="n">flush</span><span class="p">();}}</span><span class="n">io_flusher_</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">using</span> <span class="n">io</span> <span class="o">::</span> <span class="n">IN</span><span class="p">;</span>
<span class="k">using</span> <span class="n">io</span> <span class="o">::</span> <span class="n">putc</span><span class="p">;</span>
<span class="k">using</span> <span class="n">io</span> <span class="o">::</span> <span class="n">print</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="n">ll</span> <span class="n">inf</span><span class="o">=</span><span class="mh">0x3f3f3f3f3f3f3f3f</span><span class="p">;</span>
<span class="k">constexpr</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">N</span><span class="o">=</span><span class="mf">1e9</span><span class="p">,</span><span class="n">K</span><span class="o">=</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mf">1e5</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">line</span><span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">;</span>
<span class="p">}</span><span class="n">a</span><span class="p">[</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="k">struct</span> <span class="nc">segTree</span><span class="p">{</span>
	<span class="k">struct</span> <span class="nc">node</span><span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">;</span>
		<span class="n">ll</span> <span class="n">max</span><span class="p">,</span><span class="n">tag</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lChild</span><span class="p">,</span><span class="n">rChild</span><span class="p">;</span> 
	<span class="p">}</span><span class="n">t</span><span class="p">[</span><span class="n">M</span><span class="o">*</span><span class="p">(</span><span class="n">__lg</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">];</span>
	
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">clear</span><span class="p">(){</span>
		<span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">create</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">){</span>
		<span class="n">size</span><span class="o">++</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">};</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">up</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
		<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">].</span><span class="n">max</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">].</span><span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">down</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="o">=</span><span class="n">create</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="o">=</span><span class="n">create</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">+</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="p">;</span>
		<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">,</span><span class="n">ll</span> <span class="n">k</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">&amp;&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">tag</span><span class="o">+=</span><span class="n">k</span><span class="p">;</span>
			<span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="o">+=</span><span class="n">k</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">].</span><span class="n">r</span><span class="p">){</span>
			<span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">].</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">up</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ll</span> <span class="nf">query</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">,</span><span class="kt">int</span> <span class="n">l</span><span class="p">,</span><span class="kt">int</span> <span class="n">r</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">&amp;&amp;</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">down</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">ll</span> <span class="n">ans</span><span class="o">=-</span><span class="n">inf</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">].</span><span class="n">r</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">=</span><span class="n">query</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">lChild</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">].</span><span class="n">l</span><span class="o">&lt;=</span><span class="n">r</span><span class="p">){</span>
			<span class="n">ans</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span><span class="n">query</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">rChild</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span><span class="n">t</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">;</span>
<span class="n">ll</span> <span class="n">dp</span><span class="p">[</span><span class="n">M</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="cm">/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/</span>
	
	<span class="n">ios</span><span class="o">::</span><span class="n">sync_with_stdio</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
	<span class="n">cin</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="n">cout</span><span class="p">.</span><span class="n">tie</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span><span class="n">T</span><span class="p">;</span>
	<span class="n">IN</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="c1">//	cin&gt;&gt;c&gt;&gt;T;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">T</span><span class="o">--</span><span class="p">){</span>
		<span class="n">IN</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">k</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="c1">//		cin&gt;&gt;n&gt;&gt;m&gt;&gt;k&gt;&gt;d;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
		<span class="n">t</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">[</span><span class="n">M</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> 
		<span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">m</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="kt">int</span> <span class="o">&amp;</span><span class="n">l</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l</span><span class="p">,</span><span class="o">&amp;</span><span class="n">r</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span><span class="p">,</span><span class="o">&amp;</span><span class="n">w</span><span class="o">=</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
			<span class="n">IN</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="n">IN</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
<span class="c1">//			cin&gt;&gt;x&gt;&gt;y&gt;&gt;w;</span>
			<span class="n">r</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
			<span class="n">l</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
				<span class="n">tmp</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span><span class="o">=</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span><span class="p">[</span><span class="o">++</span><span class="n">len</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">tmp</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">len</span><span class="o">=</span><span class="n">unique</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">tmp</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tmp</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,[](</span><span class="n">line</span> <span class="n">a</span><span class="p">,</span><span class="n">line</span> <span class="n">b</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">!=</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">){</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">r</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">l</span><span class="o">&lt;</span><span class="n">b</span><span class="p">.</span><span class="n">l</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">});</span>
		<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1ll</span><span class="o">*</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">);</span>
			<span class="k">while</span><span class="p">(</span><span class="n">p</span><span class="o">&lt;=</span><span class="n">m</span><span class="o">&amp;&amp;</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
				<span class="n">t</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">w</span><span class="p">);</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">query</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">max</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1ll</span><span class="o">*</span><span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">;</span>
<span class="c1">//			cerr&lt;&lt;"dp["&lt;&lt;setw(5)&lt;&lt;i&lt;&lt;"][0]="&lt;&lt;setw(12)&lt;&lt;dp[i][0]&lt;&lt;" "&lt;&lt;"dp["&lt;&lt;setw(5)&lt;&lt;i&lt;&lt;"][1]="&lt;&lt;setw(12)&lt;&lt;dp[i][1]; </span>
<span class="c1">//			cerr&lt;&lt;"  r="&lt;&lt;setw(8)&lt;&lt;a[p-1].r&lt;&lt;endl;</span>
		<span class="p">}</span>
		<span class="n">print</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">len</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">dp</span><span class="p">[</span><span class="n">len</span><span class="p">][</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">putc</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
<span class="c1">//		cout&lt;&lt;max(dp[len][0],dp[len][1])&lt;&lt;'\n';</span>
	<span class="p">}</span>
	
	<span class="n">cout</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
	 
	<span class="cm">/*fclose(stdin);
	fclose(stdout);*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></div></code></pre></div></div>
</details>

于是可以写普通线段树维护，时间复杂度 $\mathcal O(m\log m)$。

# AC 代码

```cpp
//#include<bits/stdc++.h>
#include<algorithm>
#include<iostream>
#include<cstring>
#include<iomanip>
#include<cstdio>
#include<string>
#include<vector>
#include<cmath>
#include<ctime>
#include<deque>
#include<queue>
#include<stack>
#include<list>
using namespace std;
typedef long long ll; 
constexpr const ll inf=0x3f3f3f3f3f3f3f3f;
constexpr const int N=1e9,K=N,M=1e5;
struct line{
	int l,r,w;
}a[M+1];
struct segTree{
	struct node{
		int l,r;
		ll max,tag;
	}t[M<<4|1];
	
	inline void up(int p){
		t[p].max=max(t[p<<1].max,t[p<<1|1].max);
	}
	void build(int p,int l,int r){
		t[p].l=l,t[p].r=r;
		t[p].tag=0;
		if(l==r){
			t[p].max=0;
			return;
		}
		int mid=l+r>>1;
		build(p<<1,l,mid);
		build(p<<1|1,mid+1,r);
		up(p);
	}
	inline void down(int p){
		if(t[p].tag){
			t[p<<1].max+=t[p].tag;
			t[p<<1].tag+=t[p].tag;
			t[p<<1|1].max+=t[p].tag;
			t[p<<1|1].tag+=t[p].tag;
			t[p].tag=0;
		}
	}
	void add(int p,int l,int r,ll k){
		if(l<=t[p].l&&t[p].r<=r){
			t[p].tag+=k;
			t[p].max+=k;
			return;
		}
		down(p);
		if(l<=t[p<<1].r){
			add(p<<1,l,r,k);
		}
		if(t[p<<1|1].l<=r){
			add(p<<1|1,l,r,k);
		}
		up(p);
	}
	ll query(int p,int l,int r){
		if(l<=t[p].l&&t[p].r<=r){
			return t[p].max;
		}
		down(p);
		ll ans=-inf;
		if(l<=t[p<<1].r){
			ans=query(p<<1,l,r);
		}
		if(t[p<<1|1].l<=r){
			ans=max(ans,query(p<<1|1,l,r));
		}
		return ans;
	}
}t;
int n,m,k,d;
ll dp[M<<1|1][2];
int main(){
	/*freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);*/
	
	ios::sync_with_stdio(false);
	cin.tie(0);cout.tie(0);
	
	int c,T;
	cin>>c>>T;
	while(T--){
		cin>>n>>m>>k>>d;
		t.build(1,0,m<<1);
		static int tmp[M<<1|1]; 
		int len=0;
		for(int i=1;i<=m;i++){
			int &l=a[i].l,&r=a[i].r,&w=a[i].w;
			int x,y;
			cin>>x>>y>>w;
			r=x;
			l=x-y/*+1*/;
			tmp[++len]=l;
			tmp[++len]=r;
		}
		sort(tmp+1,tmp+len+1);
		len=unique(tmp+1,tmp+len+1)-tmp-1;
		for(int i=1;i<=m;i++){
			a[i].l=lower_bound(tmp+1,tmp+len+1,a[i].l)-tmp;
			a[i].r=lower_bound(tmp+1,tmp+len+1,a[i].r)-tmp;
		}
		sort(a+1,a+m+1,[](line a,line b){
			if(a.r!=b.r){
				return a.r<b.r;
			}else{
				return a.l<b.l;
			}
		});
		for(int i=1,p=1,last=0;i<=len;i++){
			dp[i][0]=max(dp[i-1][0],dp[i-1][1]);
			t.add(1,i-1,i-1,dp[i-1][0] + 1ll*tmp[i-1]*d);
			while(p<=m&&a[p].r<=i){
				t.add(1,0,a[p].l,a[p].w);
				p++;
			}
			while(tmp[last]<tmp[i]-k){
				last++;
			}
			dp[i][1]=t.query(1,last,i-1)-1ll*tmp[i]*d;
		}
		cout<<max(dp[len][0],dp[len][1])<<'\n';
	}
	
	cout.flush();
	 
	/*fclose(stdin);
	fclose(stdout);*/
	return 0;
}
```

